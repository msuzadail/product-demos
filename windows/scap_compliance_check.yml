---
- name: SCAP Compliance Checker
  hosts: "{{ HOSTS | default('os_windows') }}"
  gather_facts: false
  tasks:
  - name: Create TEMP directory
    ansible.windows.win_file:
      path: C:\Temp\
      state: directory
      
  - name: Download SCC from DISA
    ansible.windows.win_get_url:
      url: https://dl.dod.cyber.mil/wp-content/uploads/stigs/zip/scc-5.5_Windows_bundle.zip
      dest: C:\Temp\scc-5.5_Windows_bundle.zip
      force: no
      validate_certs: no
   
  - name: Unzip SCC Windows Bundle
    community.windows.win_unzip:
      src: C:\Temp\scc-5.5_Windows_bundle.zip
      dest: C:\Temp
      
  - name: Unzip exe to SCC dir
    community.windows.win_unzip:
      src: C:\Temp\scc-5.5_Windows\scc-5.5_Windows.zip
      dest: C:\SCC
      creates: C:\SCC

  - name: Copy the options.xml config file to the SCC dir
    ansible.windows.win_copy:
      src: ./files/options.xml
      dest: C:\SCC\scc_5.5\
      force: yes
      backup: yes

  - name: Run SCAP Scan
    ansible.windows.win_command: cscc.exe -o options.xml
    args:
      chdir: C:\SCC\scc_5.5

    register: scc_output

  - debug:
      var: scc_output
